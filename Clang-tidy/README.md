# Using clang-tidy

For almost all use cases, you can use the clang-tidy runner of cmake. You will still need to install clang-tidy itself. The analyzer will be run along with the compiler, so you will only see the warnings for files processed in make (and by the compiler). Files that are not completely rebuilt will not emit warnings, so you will need to `make clean` if you want to see them again. To enable clang-tidy, run cmake with the `-DTIDY=true` option. This is a cached variable, so for turning it off, run it with `-DTIDY=false`. The analyzer might not have the best performance on your machine, so if make seems hung up, be patient - it's probably just the analyzer. Should you need a standalone tool for linting (not depending on invocations of make), use the script below. Clang-tidy is generally too heavy to run on lots of code, better run it in small batches.

## Why not just use clang-tidy directly?

We want to run static analyzer checks on the C++ codes. Clang-tidy is, in principle, the best tool for the job. However, it produces warnings for calls into some included header libraries we do not want to analyze. The //NOLINT annotations in clang-tidy can solve that problem for code with only a few calls into these libraries, but not for the vast amount of calls in the NumCSE code. It would require manual editing of practically every source file, just to ignore warnings. All the standard ways to exclude output in clang-tidy, such as -header-filter, do not work here. So naturally, post-processing clang-tidy output is an option. The cmake way works by tricking clang-tidy into thinking these libraries are system headers. This can be done by replacing the respective includes in the 'compile_commands.json' by -isystem. Cmake SYSTEM flag in add_directory does exactly that and runs static checks next to building. 

## lint.py

### Run clang-tidy on NumCSE codes and filter out warnings from selected third-party includes. 

A custom clang-tidy script for the NumCSE repository. It relies heavily on cmake's 'Generate' output 'compile_commands.json', mostly because clang-tidy needs those to understand includes. The script uses a custom suppression mechanism for warnings generated by clang-tidy about matplotlibcpp and Eigen, which cannot be ignored with the usual techniques used in clang-tidy. Could be improved by parallelizing per-file, similar to LLVM's run-clang-tidy.py.

Usage is documented in the file itself, however here is minimal example which should work without errors:

 1. Change directory to your build folder (wherever cmake outputs binaries, most likely directly in your repository)
 2. Run `python ~/repositories/NumCSE/Clang-tidy/lint.py -d ~/repositories/NumCSE/LectureCodes/EigenTutorial/`.

(Possibly, you have to modify the paths so they point to the NumCSE repository).

This will run only clang-tidy on all the Eigen tutorial lecture codes and apply appropriate filters. 

#### Usage 
`python lint.py [-f <file> |-d <directory>] [-p <build_directory>] [--no_filter] [--format]`
- `-f`: process only a single file `<file>`
- `-d`: process a whole directory `<directory>`
-   neither `-f` nor `-d`: process the working directory
-   `-p`: specify the build directory `<build_directory>`, **default**: working directory
- `--no_filter`: do not filter out irrelevant warnings
- `--format`: additionally run clang-format on all processed files