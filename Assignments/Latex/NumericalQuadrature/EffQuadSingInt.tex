% NumCSE/Assignments/Chapters/NumericalQuadrature/EffQuadSingInt.tex
% Exercise requires: gauleg.cpp gauleg.hpp quadsingint_template.cpp
% Solution requires: gauleg.cpp gauleg.hpp quadsingint.cpp

\begin{samproblem}*{prb:effquadsing}{Efficient quadrature of singular integrands (core problem)}{
 This problem deals with efficient numerical quadrature of non-smooth integrands with a special structure.
 Before you tackle this problem, read about regularization of integrands by transformation \cref{rem:sqrtquad}.

 Our task is to develop quadrature formulas for integrals of the form:
 \begin{align} \label{eq:effquadsingint}
  W(f) := \int_{-1}^1 \sqrt{1 - t^2}\, f(t) dt,
 \end{align}
 where $f$ possesses an analytic extension to a complex neighbourhood of $[-1,1]$.
}

\begin{subproblem}{sp:1}[1]
  The provided function
  \begin{lstlisting}[style=cpp]
QuadRule gauleg(unsigned int n);
  \end{lstlisting}
  returns a structure \verb|QuadRule| containing nodes $(x_j)$ and weights $(w_j)$
  of a Gauss-Legendre quadrature ($\to$ \cref{def:gaussquad}) on $[-1,1]$ with $n$ nodes. 
  Have a look at the file \verb|gauleg.hpp| and \verb|gauleg.cpp|, 
  and understand how the implementation works and how to use it.
 
  \begin{samhint}
    Learn/remember how linking works in C++. To use the function \verb|gauleg| 
    (declared in \verb|gauleg.hpp| and defined in \verb|gauleg.cpp|) in a file \verb|file.cpp|, 
    first \verb|include| the header file \verb|gauleg.hpp| in the file \verb|file.cpp|, 
    and then compile and link the files \verb|gauleg.cpp| and \verb|file.cpp|. Using \verb|gcc-c++|:
    \begin{lstlisting}
g++ [compiler opts.] -c gauleg.cpp
g++ [compiler opts.] -c file.cpp
g++ [compiler opts.]  gauleg.o file.o -o exec_name
    \end{lstlisting}
    If you want to use \verb|CMake|, have a look at the file \verb|CMakeLists.txt|.
  \end{samhint}
 
% BEGIN ================ SOLUTION ===============   %
  \begin{samwriteprbpart}{solfile}
    \begin{writeverbatim}{prbfile}
      \begin{samsolution}
        For how the implementation works recall the Golub-Welsch Algorithm and have a look 
        at the codes, \verb|gauleg.hpp| and \verb|gauleg.cpp|.

        How to use the implementation is explained in the hint.
      \end{samsolution}
    \end{writeverbatim}
  \end{samwriteprbpart}
% END ================== SOLUTION ===============   %
\end{subproblem}

\begin{subproblem}{sp:2}[1]
  Study \cref{par:quadbest} in order to learn about the convergence of
  Gauss-Legendre quadrature. 

% BEGIN ================ SOLUTION ===============   %
  \begin{samwriteprbpart}{solfile}
    \begin{writeverbatim}{prbfile}
      \begin{samsolution}
        If \Blue{$f \in C^r([a,b])$} then we get algebraic convergence with rate \Blue{$r$}.

        If \Blue{$f$} has an analytic extension to a complex neighbourhood of \Blue{$[a,b]$}
        we get exponential convergence.
      \end{samsolution}
    \end{writeverbatim}
  \end{samwriteprbpart}
% END ================== SOLUTION ===============   %

\end{subproblem}

\begin{subproblem}{sp:3}[3] 
  Based on the function \verb|gauleg|, implement a C++ function
 \begin{lstlisting}[style=cpp]
template <class Function>
double quadsingint(Function&& f, const unsigned n);
 \end{lstlisting}
 that approximately evaluates \eqref{eq:effquadsingint} using $2n$ evaluations of $f$. 
 An object of type \verb|Function| must provide an evaluation operator
 \begin{lstlisting}[style=cpp]
double operator(double t) const;
 \end{lstlisting}
 For the quadrature error asymptotic exponential convergence to zero for
 $n \rightarrow \infty$ must be ensured by your function.
 
 
 \begin{samhint}
  A C++ lambda function provides such operator:
  \begin{lstlisting}[style=cpp]
auto f = [](double t){ return t*t; }; // $f(t) = t^2$
  \end{lstlisting}
 \end{samhint}
 
 \begin{samhint}
   You may use the classical binomial formula
   $\sqrt{1 - t^2} = \sqrt{1 - t} \sqrt{1 + t}$.
 \end{samhint}
 
 \begin{samhint}
  You can use the template \verb|quadsingint_template.cpp|.
 \end{samhint}

% BEGIN ================ SOLUTION ===============   %
  \begin{samwriteprbpart}{solfile}
    \begin{writeverbatim}{prbfile}
      \begin{samsolution}
        Exploiting the hint, we see that the integrand is non-smooth in $\pm 1$. 
   
        The first possible solution is the following 

        (I): we split the integration domain $[-1,1]$ in $[0,1]$ and $[-1,0]$. 
             Applying the substitution $s = \sqrt{1 \pm t}$ (sign depending on which part of the integrals considered), $t = \pm(s^2 - 1)$:
        \begin{align*}
          \frac{dt}{ds} =& \pm2s \\
          W(f) :=& \int_{-1}^1 \sqrt{1 - t^2} f(t) dt = \int_{-1}^0 \sqrt{1 - t^2} f(t) dt + \int_0^1 \sqrt{1 - t^2} f(t) dt \\
          =& \int_0^{1} 2 \cdot s^2 \sqrt{2 - s^2} f(-s^2+1) ds + \int_0^{1} 2 \cdot s^2 \sqrt{2 - s^2} f(s^2-1) ds.
        \end{align*}
        Notice how the resulting integrand is analytic in a neighbourhood of the domain
        of integration because, for instant, {$t\mapsto \sqrt{1+t}$} is analytic in a neighborhood of $[0,1]$. 
   
        Alternatively (II), one may use the trigonometric substitution $t = \sin s$ obtaining
        \begin{align*}
          \frac{dt}{ds} =& \cos s \\
          W(f) :=& \int_{-1}^1 \sqrt{1 - t^2} f(t) dt \\
          =& \int_{-\pi / 2}^{\pi / 2} \sqrt{1 - \sin^2\! s}\, f(\sin s) \cos s\,ds = \int_{-\pi / 2}^{\pi / 2} \cos^2\! s \, f(\sin s) ds.
        \end{align*}
        This integrand is also analytic.
        The C++ implementation is in \verb|quadsingint.cpp|.
      \end{samsolution}
    \end{writeverbatim}
  \end{samwriteprbpart}
% END ================== SOLUTION ===============   %

\end{subproblem}


\begin{subproblem}{sp:4}[2]
  Give formulas for the nodes $c_j$ and weights $\tilde{w}_j$ of a $2n$-point quadrature rule on $[-1,1]$, 
  whose application to the integrand $f$ will produce the same results as the function \verb|quadsingint| that you implemented in 
  \ref{prb:effquadsing:sp:3}.
  
% BEGIN ================ SOLUTION ===============   %
  \begin{samwriteprbpart}{solfile}
    \begin{writeverbatim}{prbfile}
      \begin{samsolution}
        Using substitution (I):
         
        Let $(x_j, w_j)$, $j=1,\dots,n$ be the Gauss nodes and weights relative to the Gauss quadrature of order $n$ in the interval $[0,1]$. 
        The nodes are mapped from $x_j$ in $[0,1]$ to $c_l$ for $l \in 1,\dots,2n$ in $[-1,1]$ as follows:
        \begin{align*}
          c_{2j-i}  = (-1)^i (1-x_j^2),\qquad j=1,\dots,n,\;i=0,1.  
        \end{align*}
        The weights $\tilde{w}_{l}, l = 1,\dots,2n$, become:
        \begin{align*}
          \tilde{w}_{2j-i} = 2 w_j x_j^2 \sqrt{2 - x_j^2},\qquad j=1,\dots,n,\;i=0,1.
        \end{align*}
    
        Using substitution (II):

        Let $(x_j, w_j)$, $j=1,\dots,n$ be the Gauss nodes and weights relative to the Gauss quadrature of order $n$ in the interval $[-1,1]$.  
        The nodes are mapped from $x_j$ to $c_j$  as follows:
        \begin{align*}
          c_j = \sin(x_j  \pi / 2),\qquad j=1,\dots,n
        \end{align*}
        The weights $\tilde{w}_{j}, j = 1,\dots,n$, become:
        \begin{align*}
          \tilde{w}_{j} = w_j \cos^2(x_j  \pi / 2) \pi / 2.
        \end{align*}
      \end{samsolution}
    \end{writeverbatim}
  \end{samwriteprbpart}
% END ================== SOLUTION ===============   %
\end{subproblem}



%  \begin{subproblem}[4]
%   What is the maximal degree of polynomials $f$, for which \verb|quadsingint|, in absence of round-off, will return the exact value of \eqref{eq:effquadsingint}?
%   
%    \begin{solution}
%     
%    \end{solution}
%  \end{subproblem}

\begin{subproblem}[1]
  Tabulate the quadrature error:
  \begin{align*}
    \lvert W(f) - \texttt{quadsingint(f,n)} \rvert
  \end{align*}
  for $f(t) := \frac{1}{2+\exp(3t)}$ and $n = 1,2,...,25$. 
  Estimate the $0 < q <  1$ in the decay law of exponential convergence, see \cref{def:cvgtype}. 

% BEGIN ================ SOLUTION ===============   %
  \begin{samwriteprbpart}{solfile}
    \begin{writeverbatim}{prbfile}
      \begin{samsolution}
        The convergence is exponential with both methods. The C++ implementation is in \verb|quadsingint.cpp|.
      \end{samsolution}
    \end{writeverbatim}
  \end{samwriteprbpart}
% END ================== SOLUTION ===============   %
\end{subproblem}
 
\end{samproblem}
